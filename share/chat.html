<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat • Hug-Oh</title>
  <link rel="icon" href="hug.svg" type="image/svg+xml">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    html, body { height: 100%; }
    
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: #292828;
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .bubbles {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: 0;
      overflow: hidden;
      pointer-events: none;
    }
    .bubble {
      position: absolute;
      bottom: -150px;
      border-radius: 50%;
      animation: rise 10s linear forwards;
      filter: blur(4px);
    }
    @keyframes rise {
      0% { transform: translateY(0) scale(1); opacity: 0.8; }
      90% { opacity: 1; }
      100% { transform: translateY(-120vh) scale(1.2); opacity: 0; }
    }
    .bubble span { position: absolute; border-radius: 50%; }
    .bubble span:nth-child(1) { inset: 10px; border-left: 10px solid #0fb4ff; filter: blur(6px); }
    .bubble span:nth-child(2) { inset: 10px; border-right: 10px solid #ff4484; filter: blur(6px); }
    .bubble span:nth-child(3) { inset: 10px; border-top: 10px solid #ffeb3b; filter: blur(6px); }
    .bubble span:nth-child(4) { inset: 20px; border-left: 10px solid #ff4484; filter: blur(10px); }
    .bubble span:nth-child(5) { inset: 10px; border-bottom: 8px solid #fff; filter: blur(6px); transform: rotate(330deg); }
    .card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(8px);
      border-radius: 1rem;
      padding: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .btn {
      width: auto;
      min-width: 100px;
      height: 36px;
      cursor: pointer;
      color: #fff;
      font-size: 14px;
      font-weight: bold;
      border-radius: 25px;
      border: 3px solid transparent;
      background: transparent;
      background-image: linear-gradient(#292828, #292828),
                        linear-gradient(135deg, #0fb4ff, #ff4484, #ffeb3b, #ffffff);
      background-origin: border-box;
      background-clip: padding-box, border-box;
      transition: 0.3s;
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.2);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0 1.5rem;
    }
    .btn:hover {
      transform: scale(1.05);
      color: #ffeb3b;
      box-shadow: 0 0 18px rgba(255, 255, 255, 0.6),
                  0 0 25px rgba(255, 68, 132, 0.5),
                  0 0 35px rgba(15, 180, 255, 0.4);
    }
    .btn-icon {
        width: 36px;
        min-width: 36px;
        height: 36px;
        padding: 0;
    }
    header {
      position: relative;
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(6px);
    }
    header img {
      height: 45px;
      animation: pulse-glow 3s infinite ease-in-out;
    }
    @keyframes pulse-glow {
      0%, 100% { transform: scale(1); filter: drop-shadow(0 0 5px #0fb4ff); }
      50% { transform: scale(1.1); filter: drop-shadow(0 0 15px #ff4484); }
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      justify-content: center;
      align-items: center;
      z-index: 50;
    }
    .modal-content {
      background: #292828;
      padding: 2rem;
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      width: 90%;
      max-width: 400px;
    }
    .message-bubble {
        position: relative;
    }
    .message-options-toggle {
        position: absolute;
        top: 5px;
        right: 5px;
        background: none;
        border: none;
        color: white;
        font-weight: bold;
        cursor: pointer;
    }
    .message-options {
        display: none;
        position: absolute;
        top: 25px;
        right: 5px;
        background: #444;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        z-index: 20;
    }
    .message-options.show {
        display: flex;
        flex-direction: column;
    }
    .reply-preview {
        background-color: #555;
        padding: 5px;
        border-left: 3px solid #0fb4ff;
        margin-bottom: 5px;
        border-radius: 3px;
    }
    /* Estilos para el contenedor de archivos */
    .file-container {
        max-width: 100%;
        overflow: hidden;
    }
    .file-container img {
        max-width: 100%;
        border-radius: 8px;
        margin-top: 5px;
    }
    .file-container a {
        display: block;
        background: #5a6677;
        padding: 8px;
        border-radius: 8px;
        margin-top: 5px;
        text-decoration: none;
        color: #fff;
        text-align: center;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
    }
    /* Estilos para el menú de opciones de los chats/grupos */
    .chat-item-options {
        position: absolute;
        top: 0;
        right: 0;
        background: none;
        border: none;
        color: white;
        font-weight: bold;
        cursor: pointer;
        padding: 8px;
    }
    .chat-item-options-menu {
        display: none;
        position: absolute;
        top: 30px;
        right: 0;
        background: #444;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        z-index: 20;
    }
    .chat-item-options-menu.show {
        display: flex;
        flex-direction: column;
    }
    .add-contact-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 20;
        background: none;
        border: none;
        cursor: pointer;
    }
    .add-contact-options {
        display: none;
        position: absolute;
        top: 60px;
        right: 1rem;
        background: #444;
        border-radius: 1rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        z-index: 30;
    }
    .add-contact-options.show {
        display: flex;
        flex-direction: column;
    }
    .new-chat-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        justify-content: center;
        align-items: center;
        z-index: 100;
    }
    .new-chat-modal-content {
        background: #292828;
        padding: 2rem;
        border-radius: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        width: 90%;
        max-width: 400px;
    }
    .new-chat-form {
        display: none;
    }

    /* Estilos para las barras de scroll */
    .scrollbar-custom::-webkit-scrollbar {
        width: 8px;
        background-color: transparent;
    }
    .scrollbar-custom::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        transition: background-color 0.3s;
    }
    .scrollbar-custom::-webkit-scrollbar-thumb:hover {
        background-color: rgba(255, 255, 255, 0.4);
    }
  </style>
</head>
<body>
  <div class="bubbles" id="bubbles"></div>

  <header>
    <img src="hugw.svg" alt="Logo Hug-Oh" onclick="window.location.href='index.html'">
    <div id="auth-ui" class="flex gap-4 items-center"></div>
    <a href="share.html" class="btn btn-icon">
    <img src="svg/hogar.svg" alt="Inicio" class="w-5 h-5" style="color: white">
    </a>
  </header>
  <main class="flex flex-1 h-[calc(100vh-80px) p-4 gap-4 relative z-10">
    <div id="chatListContainer" class="card w-full lg:w-1/3 flex flex-col space-y-4 relative">
      <button id="addContactBtn" class="add-contact-btn">
        <img src="svg/agregarcontacto.svg" alt="Agregar contacto" class="w-6 h-6" style="filter: brightness(0) invert(1);">
      </button>

      <div>
        <h2 class="text-lg font-bold mb-2">Mis Grupos</h2>
        <div id="groupsList" class="h-64 overflow-y-auto text-sm space-y-2 mb-2 scrollbar-custom"></div>
      </div>
      <hr class="border-gray-600">
      <div>
        <h2 class="text-lg font-bold mb-2">Chats Privados</h2>
        <div id="privatesList" class="h-64 overflow-y-auto text-sm space-y-2 mb-2 scrollbar-custom"></div>
      </div>
    </div>

    <div id="chatMainContainer" class="card flex-1 flex-col flex hidden lg:flex">
      <div class="chat-nav flex justify-between items-center mb-2">
        <div class="flex items-center gap-2">
          <button id="btnBackToChats" class="btn btn-icon lg:hidden">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
          </button>
          <div>
            <strong id="chatTitle">Selecciona un chat</strong>
            <div id="chatMembers" class="text-xs text-gray-400"></div>
          </div>
        </div>
        <div class="flex gap-2 items-center">
          <button id="btnInvite" class="btn hidden">Invitar</button>
          <button id="btnLeave" class="btn btn-icon">
             <img src="svg/salir.svg" alt="Salir" class="w-5 h-5" style="filter: brightness(0) invert(1);">
          </button>
        </div>
      </div>
      <div id="messagesWrap" class="flex-1 overflow-auto space-y-3 min-h-0 scrollbar-custom">
        <p class="text-gray-400">No hay chat abierto.</p>
      </div>
      <div class="mt-3 flex flex-col gap-2">
        <div id="reply-preview" class="reply-preview hidden">
          <p class="text-xs text-gray-300">Respondiendo a: <span id="reply-author" class="font-bold"></span></p>
          <p id="reply-text" class="text-sm italic text-gray-400 truncate"></p>
        </div>
        <textarea id="messageInput" placeholder="Escribe un mensaje..."
          rows="2" class="w-full bg-gray-700 text-white rounded-md p-2"></textarea>
        <div class="flex justify-end gap-2 items-center">
          <input type="file" id="fileInput" class="hidden"/>
          
          <button id="scrollToBottomBtn" class="btn btn-icon hidden">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 5.25l-7.5 7.5-7.5-7.5m15 6l-7.5 7.5-7.5-7.5" />
            </svg>
          </button>
          
          <button id="btnAttach" class="btn btn-icon">
            <img src="svg/adjuntar.svg" alt="Adjuntar" class="w-5 h-5" style="filter: brightness(0) invert(1);">
          </button>
          <button id="btnSend" class="btn">
            <img src="svg/enviar.svg" alt="Enviar" class="w-5 h-5" style="filter: brightness(0) invert(1);">
          </button>
        </div>
      </div>
    </div>
  </main>

  <div id="newChatModal" class="new-chat-modal">
    <div id="newChatModalContent" class="new-chat-modal-content">
      <h3 id="modalTitle" class="text-lg font-bold mb-4">Añadir</h3>
      <div id="modalMenu" class="flex flex-col gap-4">
        <button id="btnShowNewGroup" class="btn">
          <img src="svg/grupo.svg" alt="Crear grupo" class="w-5 h-5" style="filter: brightness(0) invert(1);">
          Crear Grupo
        </button>
        <button id="btnShowNewPrivate" class="btn">
          <img src="svg/contacto.svg" alt="Iniciar chat" class="w-5 h-5" style="filter: brightness(0) invert(1);">
          Iniciar Chat
        </button>
      </div>

      <form id="newGroupForm" class="new-chat-form flex flex-col gap-4">
        <input id="newGroupName" type="text" placeholder="Nombre del grupo" class="w-full bg-gray-700 text-white rounded-md p-2"/>
        <div class="flex justify-end gap-2">
          <button type="button" id="btnCancelGroup" class="btn w-1/2">Cancelar</button>
          <button type="submit" id="btnNewGroup" class="btn w-1/2">Crear Grupo</button>
        </div>
      </form>

      <form id="newPrivateForm" class="new-chat-form flex flex-col gap-4">
        <input id="newPrivateUser" type="text" placeholder="Usuario para chatear" class="w-full bg-gray-700 text-white rounded-md p-2"/>
        <div class="flex justify-end gap-2">
          <button type="button" id="btnCancelPrivate" class="btn w-1/2">Cancelar</button>
          <button type="submit" id="btnNewPrivate" class="btn w-1/2">Iniciar Chat</button>
        </div>
      </form>
    </div>
  </div>

  <div id="inviteModal" class="modal">
    <div class="modal-content">
      <h3 class="text-lg font-bold mb-4">Invitar a un usuario</h3>
      <input id="inviteUserInput" type="text" placeholder="Nombre de usuario"
        class="w-full bg-gray-700 text-white rounded-md p-2 mb-4"/>
      <div class="flex justify-end gap-2">
        <button id="btnCancelInvite" class="btn w-1/2">Cancelar</button>
        <button id="btnSendInvite" class="btn w-1/2">Invitar</button>
      </div>
    </div>
  </div>

  <div id="reactModal" class="modal">
    <div class="modal-content text-center">
      <h3 class="text-lg font-bold mb-4">Reaccionar con un emoji</h3>
      <div id="emoji-list" class="grid grid-cols-6 gap-4 text-2xl cursor-pointer">
        <span>👍</span><span>❤️</span><span>😂</span><span>😮</span><span>😢</span><span>😡</span>
        <span>🔥</span><span>🎉</span><span>🤯</span><span>👏</span><span>💯</span><span>🚀</span>
      </div>
      <button id="btnCancelReact" class="btn mt-4 w-full">Cancelar</button>
    </div>
  </div>

  <div id="forwardModal" class="modal">
    <div class="modal-content">
      <h3 class="text-lg font-bold mb-4">Reenviar a:</h3>
      <div id="forward-chat-list" class="flex flex-col space-y-2 max-h-60 overflow-y-auto"></div>
      <button id="btnCancelForward" class="btn mt-4 w-full">Cancelar</button>
    </div>
  </div>

      <footer class="relative z-20 text-center p-4 bg-black bg-opacity-40 mt-auto">
        <p>© 2025 Hug-Share! • Creado por Hug-Oh</p>
    </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, getDoc, getDocs,
      onSnapshot, query, where, serverTimestamp, orderBy, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";


    const firebaseConfig = {
      apiKey: "AIzaSyD3377y1-OurIh8o-FtIb8j2kePjTlqHbU",
      authDomain: "hug-share.firebaseapp.com",
      projectId: "hug-share",
      storageBucket: "hug-share.appspot.com",
      messagingSenderId: "416013649417",
      appId: "1:416013649417:web:a07f37a4069a158da55ad8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    console.log("Firebase inicializado");

    // RUTA BASE PARA LAS COLECCIONES (esto coincide con tus reglas)
    const appPath = "artifacts/default-app-id/public/data";

    let currentUser = null;
    let currentChat = null;
    let unsubMessages = null;
    let replyToMessageId = null;
    let forwardedMessageText = null;
    let forwardedAuthorName = null;

    // Variables para manejar el archivo adjunto
    let fileToSend = null;
    let fileNameToSend = null;
    let fileTypeToSend = null;

    const chatListContainer = document.getElementById("chatListContainer");
    const chatMainContainer = document.getElementById("chatMainContainer");
    const groupsList = document.getElementById("groupsList");
    const privatesList = document.getElementById("privatesList");
    const chatTitle = document.getElementById("chatTitle");
    const chatMembers = document.getElementById("chatMembers");
    const messagesWrap = document.getElementById("messagesWrap");
    const messageInput = document.getElementById("messageInput");
    const btnSend = document.getElementById("btnSend");
    const btnLeave = document.getElementById("btnLeave");
    const btnBackToChats = document.getElementById("btnBackToChats");
    const btnInvite = document.getElementById("btnInvite");
    const inviteModal = document.getElementById("inviteModal");
    const inviteUserInput = document.getElementById("inviteUserInput");
    const btnSendInvite = document.getElementById("btnSendInvite");
    const btnCancelInvite = document.getElementById("btnCancelInvite");
    const replyPreview = document.getElementById("reply-preview");
    const replyAuthor = document.getElementById("reply-author");
    const replyText = document.getElementById("reply-text");
    const reactModal = document.getElementById("reactModal");
    const emojiList = document.getElementById("emoji-list");
    const btnCancelReact = document.getElementById("btnCancelReact");
    const forwardModal = document.getElementById("forwardModal");
    const forwardChatList = document.getElementById("forward-chat-list");
    const btnCancelForward = document.getElementById("btnCancelForward");
    const fileInput = document.getElementById("fileInput");
    const btnAttach = document.getElementById("btnAttach");
    const scrollToBottomBtn = document.getElementById("scrollToBottomBtn");

    // NUEVOS ELEMENTOS PARA EL MODAL DE CREACIÓN
    const newChatModal = document.getElementById('newChatModal');
    const modalMenu = document.getElementById('modalMenu');
    const newGroupForm = document.getElementById('newGroupForm');
    const newPrivateForm = document.getElementById('newPrivateForm');
    const modalTitle = document.getElementById('modalTitle');
    const addContactBtn = document.getElementById('addContactBtn');

    // Limite de tamaño para la compresión de imágenes (1MB)
    const MAX_IMAGE_SIZE_BYTES = 1024 * 1024;

    function createBubble() {
      const bubble = document.createElement("div");
      bubble.classList.add("bubble");
      bubble.style.left = Math.random() * 100 + "vw";
      const size = Math.random() * 80 + 40;
      bubble.style.width = bubble.style.height = size + "px";
      bubble.style.animationDuration = (Math.random() * 5 + 6) + "s";
      for (let i = 0; i < 5; i++) {
        const span = document.createElement("span");
        bubble.appendChild(span);
      }
      document.getElementById("bubbles").appendChild(bubble);
      setTimeout(() => bubble.remove(), 12000);
    }
    setInterval(createBubble, 1000);

    // --- Lógica para seleccionar y comprimir archivos ---
    btnAttach.onclick = () => {
      fileInput.click();
    };

    fileInput.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;

      fileToSend = null;
      fileNameToSend = null;
      fileTypeToSend = null;

      if (file.type.startsWith("image/") && file.size > MAX_IMAGE_SIZE_BYTES) {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);

            fileToSend = compressedBase64;
            fileNameToSend = file.name;
            fileTypeToSend = 'image/jpeg';
            messageInput.value = `[Imagen comprimida: ${file.name}]`;
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      } else {
        const reader = new FileReader();
        reader.onload = (event) => {
          fileToSend = event.target.result;
          fileNameToSend = file.name;
          fileTypeToSend = file.type;
          messageInput.value = `[Archivo: ${file.name}]`;
        };
        reader.readAsDataURL(file);
      }
    };
    
    // --- Lógica de scroll inteligente ---
    function checkScroll() {
      const isAtBottom = messagesWrap.scrollHeight - messagesWrap.scrollTop - messagesWrap.clientHeight < 5;
      if (isAtBottom) {
        scrollToBottomBtn.classList.add('hidden');
      } else {
        scrollToBottomBtn.classList.remove('hidden');
      }
    }

    messagesWrap.onscroll = () => {
      checkScroll();
    };

    scrollToBottomBtn.onclick = () => {
      messagesWrap.scrollTop = messagesWrap.scrollHeight;
    };

    function closeAllOptionMenus() {
        document.querySelectorAll('.message-options').forEach(menu => {
            menu.classList.remove('show');
        });
        document.querySelectorAll('.chat-item-options-menu').forEach(menu => {
            menu.classList.remove('show');
        });
    }
    
    // --- Lógica del nuevo overlay de Añadir Contacto ---
    addContactBtn.onclick = () => {
      newChatModal.style.display = 'flex';
      modalMenu.style.display = 'flex';
      newGroupForm.style.display = 'none';
      newPrivateForm.style.display = 'none';
      modalTitle.textContent = 'Añadir';
    };

    document.getElementById('btnShowNewGroup').onclick = () => {
      modalMenu.style.display = 'none';
      newGroupForm.style.display = 'flex';
      newPrivateForm.style.display = 'none';
      modalTitle.textContent = 'Crear Grupo';
    };

    document.getElementById('btnShowNewPrivate').onclick = () => {
      modalMenu.style.display = 'none';
      newGroupForm.style.display = 'none';
      newPrivateForm.style.display = 'flex';
      modalTitle.textContent = 'Iniciar Chat';
    };

    // Nuevo manejador de clics para cerrar el modal de manera segura
    newChatModal.onclick = (e) => {
      // Si el clic es en el fondo (el modal en sí, no su contenido), lo cerramos
      if (e.target === newChatModal) {
        newChatModal.style.display = 'none';
      }
    };

    document.getElementById('btnCancelGroup').onclick = () => {
      newChatModal.style.display = 'none';
    };

    document.getElementById('btnCancelPrivate').onclick = () => {
      newChatModal.style.display = 'none';
    };

    // --- Crear grupo (modificado para el formulario) ---
    newGroupForm.onsubmit = async (e) => {
      e.preventDefault();
      const name = document.getElementById("newGroupName").value.trim();
      if (!name) return alert("Escribe un nombre de grupo.");
      await addDoc(collection(db, `${appPath}/groups`), {
        name,
        owner: currentUser.uid,
        members: [currentUser.uid],
        membersNames: [currentUser.displayName || currentUser.email],
        createdAt: serverTimestamp()
      });
      document.getElementById("newGroupName").value = "";
      newChatModal.style.display = 'none';
    };
    
    // --- Iniciar chat privado (CORREGIDO) ---
    newPrivateForm.onsubmit = async (e) => {
      e.preventDefault();
      try {
        const uname = document.getElementById("newPrivateUser").value.trim().toLowerCase();
        if (!uname) {
            console.warn("Advertencia: El campo de usuario está vacío.");
            return alert("Escribe un usuario.");
        }
      
        console.log(`Paso 1: Buscando usuario con nombre: "${uname}" en la colección ${appPath}/users`);
        const q = query(
          collection(db, `${appPath}/users`),
          where("name","==", uname)
        );
        const snap = await getDocs(q);

        if (snap.empty) {
          console.error("Error: Usuario no encontrado. Verifica que el usuario existe y que el nombre de usuario es exactamente el que buscas.");
          return alert("Usuario no encontrado.");
        }
      
        const otherDoc = snap.docs[0];
        const otherId = otherDoc.id;
        console.log(`Paso 2: Usuario encontrado. UID: ${otherId}`);

        if (otherId === currentUser.uid) {
          console.warn("Advertencia: Intento de chatear con uno mismo.");
          return alert("No puedes chatear contigo mismo.");
        }

        console.log(`Paso 3: Buscando chat privado existente entre ${currentUser.uid} y ${otherId}`);
        const existingChatQuery = query(
            collection(db, `${appPath}/privateChats`),
            where("participants", "array-contains", currentUser.uid)
        );
        const existingChats = await getDocs(existingChatQuery);
        
        let chatExists = false;
        existingChats.forEach(chatDoc => {
            const data = chatDoc.data();
            if (data.participants.includes(otherId)) {
                chatExists = true;
                console.warn(`Paso 3.1: Se encontró un chat existente con el ID: ${chatDoc.id}`);
            }
        });

        if (chatExists) {
            console.warn("Advertencia: Ya existe un chat con este usuario.");
            alert("Ya tienes un chat privado con este usuario.");
            document.getElementById("newPrivateUser").value = "";
            return;
        }

        console.log("Paso 4: No se encontró un chat previo, creando uno nuevo...");
        await addDoc(collection(db, `${appPath}/privateChats`), {
          participants: [currentUser.uid, otherId],
          createdAt: serverTimestamp()
        });

        console.log("Paso 5: Chat creado exitosamente.");
        document.getElementById("newPrivateUser").value = "";
        newChatModal.style.display = 'none';
      } catch (error) {
        console.error("Un error inesperado ocurrió en el formulario de chat privado:", error);
        alert("Ocurrió un error al intentar crear el chat. Por favor, revisa la consola para más detalles.");
      }
    };

    // --- Cargar grupos ---
    async function loadGroups() {
      const q = query(collection(db, `${appPath}/groups`),
                      where("members", "array-contains", currentUser.uid));
      onSnapshot(q, (snap) => {
        groupsList.innerHTML = "";
        if (snap.empty) {
          groupsList.innerHTML = "<p class='text-gray-400'>No tienes grupos.</p>";
          return;
        }
        snap.forEach(docSnap => {
          const data = docSnap.data();
          const div = document.createElement("div");
          div.className = "p-2 rounded cursor-pointer hover:bg-gray-700 relative";
          div.innerHTML = `<img src="svg/grupo.svg" alt="Grupo" class="w-5 h-5 inline-block mr-2" style="filter: brightness(0) invert(1);"> ${data.name}
            <button class="chat-item-options" onclick="event.stopPropagation(); toggleChatOptions(event, 'group', '${docSnap.id}')">...</button>
            <div id="options-group-${docSnap.id}" class="chat-item-options-menu p-1">
              <button class="text-sm px-2 py-1 hover:bg-gray-500 rounded" onclick="handleLeaveGroup('${docSnap.id}')"><img src="svg/salir.svg" alt="Salir" class="w-4 h-4 inline-block mr-1" style="filter: brightness(0) invert(1);"> Salir</button>
              <button class="text-sm px-2 py-1 hover:bg-red-500 rounded" onclick="handleDeleteGroup('${docSnap.id}', '${data.owner}')"><img src="svg/eliminar.svg" alt="Borrar" class="w-4 h-4 inline-block mr-1" style="filter: brightness(0) invert(1);"> Borrar</button>
            </div>
          `;
          div.onclick = () => openChat("group", docSnap.id, data, data.name);
          groupsList.appendChild(div);
        });
      }, (error) => {
        console.error("Error al cargar los grupos:", error);
        groupsList.innerHTML = "<p class='text-red-400'>Error al cargar los grupos. Revisa la consola.</p>";
      });
    }

    window.toggleChatOptions = (e, type, id) => {
        e.stopPropagation();
        closeAllOptionMenus();
        const menu = document.getElementById(`options-${type}-${id}`);
        menu.classList.toggle('show');
    };

    // --- Borrar grupo ---
    window.handleDeleteGroup = async (groupId, groupOwnerId) => {
        closeAllOptionMenus();
        if (groupOwnerId !== currentUser.uid) {
            alert("Solo el propietario del grupo puede borrarlo.");
            return;
        }
        if (confirm("¿Estás seguro de que quieres borrar este grupo y todos sus mensajes?")) {
            const groupMessagesRef = collection(db, `${appPath}/groups/${groupId}/messages`);
            const messagesSnap = await getDocs(groupMessagesRef);
            const deletePromises = [];
            messagesSnap.forEach(docSnap => {
                deletePromises.push(deleteDoc(docSnap.ref));
            });
            await Promise.all(deletePromises);
            await deleteDoc(doc(db, `${appPath}/groups`, groupId));
            alert("Grupo borrado.");
            btnLeave.click();
        }
    };

    window.handleLeaveGroup = async (groupId) => {
        closeAllOptionMenus();
        if (confirm("¿Estás seguro de que quieres salir de este grupo?")) {
            const groupRef = doc(db, `${appPath}/groups`, groupId);
            const groupSnap = await getDoc(groupRef);
            if (groupSnap.exists()) {
                const data = groupSnap.data();
                const updatedMembers = data.members.filter(memberId => memberId !== currentUser.uid);
                const updatedNames = data.membersNames.filter(name => name !== (currentUser.displayName || currentUser.email));
                if (updatedMembers.length === 0) {
                    await deleteDoc(groupRef);
                } else {
                    await updateDoc(groupRef, {
                        members: updatedMembers,
                        membersNames: updatedNames
                    });
                }
                alert("Has salido del grupo.");
                btnLeave.click();
            }
        }
    };

    // --- Cargar chats privados ---
    async function loadPrivates() {
      const q = query(collection(db, `${appPath}/privateChats`),
                      where("participants", "array-contains", currentUser.uid));
      onSnapshot(q, async (snap) => {
        privatesList.innerHTML = "";
        if (snap.empty) {
          privatesList.innerHTML = "<p class='text-gray-400'>No tienes chats privados.</p>";
          return;
        }
        for (const docSnap of snap.docs) {
          const data = docSnap.data();
          const otherId = (data.participants || []).find(uid => uid !== currentUser.uid);

          if (!otherId) continue;

          const otherUserDoc = await getDoc(doc(db, `${appPath}/users`, otherId));
          const otherUserName = otherUserDoc.exists() ? otherUserDoc.data().name : 'Usuario Desconocido';
          
          const div = document.createElement("div");
          div.className = "p-2 rounded cursor-pointer hover:bg-gray-700 relative";
          div.innerHTML = `<img src="svg/contacto.svg" alt="Chat privado" class="w-5 h-5 inline-block mr-2" style="filter: brightness(0) invert(1);"> ${otherUserName}
            <button class="chat-item-options" onclick="event.stopPropagation(); toggleChatOptions(event, 'private', '${docSnap.id}')">...</button>
            <div id="options-private-${docSnap.id}" class="chat-item-options-menu p-1">
                <button class="text-sm px-2 py-1 hover:bg-red-500 rounded" onclick="handleDeletePrivateChat('${docSnap.id}')"><img src="svg/eliminar.svg" alt="Borrar" class="w-4 h-4 inline-block mr-1" style="filter: brightness(0) invert(1);"> Borrar</button>
            </div>
          `;
          div.onclick = () => openChat("private", docSnap.id, data, otherUserName);
          privatesList.appendChild(div);
        }
      }, (error) => {
        console.error("Error al cargar los chats privados:", error);
        privatesList.innerHTML = "<p class='text-red-400'>Error al cargar los chats. Revisa la consola.</p>";
      });
    }

    // --- Borrar chat privado ---
    window.handleDeletePrivateChat = async (chatId) => {
        closeAllOptionMenus();
        if (confirm("¿Estás seguro de que quieres borrar este chat?")) {
            const chatMessagesRef = collection(db, `${appPath}/privateChats/${chatId}/messages`);
            const messagesSnap = await getDocs(chatMessagesRef);
            const deletePromises = [];
            messagesSnap.forEach(docSnap => {
                deletePromises.push(deleteDoc(docSnap.ref));
            });
            await Promise.all(deletePromises);
            await deleteDoc(doc(db, `${appPath}/privateChats`, chatId));
            alert("Chat borrado.");
            btnLeave.click();
        }
    };

    // --- Abrir chat ---
    function openChat(type, id, data, chatTitleText) {
      if (unsubMessages) {
        unsubMessages();
      }

      currentChat = { type, id, data };
      chatTitle.textContent = chatTitleText;
      
      const membersText = data.membersNames ? `(${data.membersNames.join(", ")})` : '';
      chatMembers.textContent = membersText;

      messagesWrap.innerHTML = "";
      
      const q = query(
        collection(db, type === "group" ? `${appPath}/groups/${id}/messages` : `${appPath}/privateChats/${id}/messages`),
        orderBy("createdAt")
      );
      
      // Mostrar el contenedor del chat y ocultar la lista en móviles
      chatListContainer.classList.add('hidden');
      chatMainContainer.classList.remove('hidden');
      chatMainContainer.classList.add('flex');

      unsubMessages = onSnapshot(q, async (messagesSnap) => {
        const wasAtBottom = messagesWrap.scrollHeight - messagesWrap.scrollTop - messagesWrap.clientHeight < 5;

        messagesWrap.innerHTML = "";
        for (const msgDoc of messagesSnap.docs) {
          const msgData = msgDoc.data();
          const div = document.createElement("div");
          div.className = "bg-gray-700 rounded-lg p-2 max-w-lg relative message-bubble " + (msgData.authorId === currentUser.uid ? "ml-auto" : "");
          
          if (msgData.replyToId) {
            const repliedMsgRef = doc(db, `${currentChat.type === 'group' ? `${appPath}/groups` : `${appPath}/privateChats`}/${currentChat.id}/messages/${msgData.replyToId}`);
            const repliedMsgSnap = await getDoc(repliedMsgRef);
            if (repliedMsgSnap.exists()) {
              const repliedData = repliedMsgSnap.data();
              const replyDiv = document.createElement("div");
              replyDiv.className = "reply-preview";
              replyDiv.innerHTML = `<p class="text-xs text-gray-300">Respondiendo a: <span class="font-bold">${repliedData.authorName}</span></p><p class="text-sm italic text-gray-400 truncate">${repliedData.text}</p>`;
              div.appendChild(replyDiv);
            }
          }
          
          if (msgData.originalAuthorName) {
            const forwardDiv = document.createElement("div");
            forwardDiv.className = "text-xs italic text-gray-400 mb-1";
            forwardDiv.textContent = `Reenviado de: ${msgData.originalAuthorName}`;
            div.appendChild(forwardDiv);
          }

          div.innerHTML += `<p class="font-bold text-sm">${msgData.authorName || 'Anónimo'}</p>`;
          
          // Renderizar el mensaje o el archivo
          if (msgData.fileData) {
              const fileContainer = document.createElement("div");
              fileContainer.className = "file-container";
              if (msgData.fileType && msgData.fileType.startsWith("image/")) {
                  const img = document.createElement("img");
                  img.src = msgData.fileData;
                  img.alt = msgData.fileName || "Imagen";
                  fileContainer.appendChild(img);
              } else {
                  const fileLink = document.createElement("a");
                  fileLink.href = msgData.fileData;
                  fileLink.download = msgData.fileName || "archivo";
                  fileLink.textContent = `Descargar: ${msgData.fileName || "archivo"}`;
                  fileContainer.appendChild(fileLink);
              }
              div.appendChild(fileContainer);
          } else {
              div.innerHTML += `<p class="text-sm">${msgData.text}</p>`;
          }

          // Botón de opciones
          const optionsToggleBtn = document.createElement("button");
          optionsToggleBtn.className = "message-options-toggle";
          optionsToggleBtn.textContent = "...";
          optionsToggleBtn.onclick = (e) => toggleMessageOptions(e, msgDoc.id, msgData);
          div.appendChild(optionsToggleBtn);

          // Menú de opciones
          const optionsDiv = document.createElement("div");
          optionsDiv.id = `options-${msgDoc.id}`;
          optionsDiv.className = "message-options p-1";
          optionsDiv.innerHTML = `
            <button class="text-sm px-2 py-1 hover:bg-gray-500 rounded" onclick="window.handleReply('${msgDoc.id}', '${msgData.authorName}', \`${msgData.text || ''}\`)"><img src="svg/responder.svg" alt="Responder" class="w-4 h-4 inline-block mr-1" style="filter: brightness(0) invert(1);"> Responder</button>
            <button class="text-sm px-2 py-1 hover:bg-gray-500 rounded" onclick="window.handleReact('${msgDoc.id}')"><img src="svg/reaccionar.svg" alt="Reaccionar" class="w-4 h-4 inline-block mr-1" style="filter: brightness(0) invert(1);"> Reaccionar</button>
            <button class="text-sm px-2 py-1 hover:bg-gray-500 rounded" onclick="window.handleForward(\`${msgData.text || ''}\`, '${msgData.authorName}')"><img src="svg/reenviar.svg" alt="Reenviar" class="w-4 h-4 inline-block mr-1" style="filter: brightness(0) invert(1);"> Reenviar</button>
          `;
          if (msgData.authorId === currentUser.uid) {
              optionsDiv.innerHTML += `<button class="text-sm px-2 py-1 hover:bg-red-500 rounded" onclick="handleDelete('${msgDoc.id}')"><img src="svg/eliminar.svg" alt="Borrar" class="w-4 h-4 inline-block mr-1" style="filter: brightness(0) invert(1);"> Borrar</button>`;
          }
          div.appendChild(optionsDiv);

          messagesWrap.appendChild(div);
        }
        
        // Desplazar al final solo después de que se cargan los mensajes
        messagesWrap.scrollTop = messagesWrap.scrollHeight;

        if (wasAtBottom) {
            messagesWrap.scrollTop = messagesWrap.scrollHeight;
        }
        checkScroll();
      });

      if (type === "group") {
        btnInvite.classList.remove("hidden");
      } else {
        btnInvite.classList.add("hidden");
      }
    }

    function toggleMessageOptions(e, messageId) {
        e.stopPropagation();
        closeAllOptionMenus();
        
        const menu = document.getElementById(`options-${messageId}`);
        menu.classList.toggle('show');
    }

    // --- Lógica de borrado de mensajes (CORREGIDA) ---
    window.handleDelete = async (messageId) => {
      if (!currentChat) return alert("Selecciona un chat primero.");
      if (confirm("¿Estás seguro de que quieres borrar este mensaje?")) {
        try {
            const messageRef = doc(db, `${currentChat.type === 'group' ? `${appPath}/groups` : `${appPath}/privateChats`}/${currentChat.id}/messages/${messageId}`);
            await deleteDoc(messageRef);
            console.log("Mensaje borrado con éxito.");
        } catch (error) {
            console.error("Error al borrar el mensaje: ", error);
            alert("Error al borrar el mensaje. Revisa la consola.");
        }
      }
      closeAllOptionMenus();
    };

    // --- Enviar mensaje (modificado para archivos) ---
    btnSend.onclick = async () => {
      if (!currentChat) return;
      const text = messageInput.value.trim();
      
      if (fileToSend) {
          const chatPath = currentChat.type === "group" ? `${appPath}/groups/${currentChat.id}/messages` : `${appPath}/privateChats/${currentChat.id}/messages`;
          
          await addDoc(collection(db, chatPath), {
              text: text || '',
              authorId: currentUser.uid,
              authorName: currentUser.displayName || currentUser.email,
              createdAt: serverTimestamp(),
              fileData: fileToSend,
              fileName: fileNameToSend,
              fileType: fileTypeToSend
          });
          
          fileToSend = null;
          fileNameToSend = null;
          fileTypeToSend = null;
          messageInput.value = "";
          messagesWrap.scrollTop = messagesWrap.scrollHeight;
          return;
      }

      if (!text) return;

      const chatPath = currentChat.type === "group" ? `${appPath}/groups/${currentChat.id}/messages` : `${appPath}/privateChats/${currentChat.id}/messages`;
      
      const messageData = {
        text,
        authorId: currentUser.uid,
        authorName: currentUser.displayName || currentUser.email,
        createdAt: serverTimestamp()
      };

      if (replyToMessageId) {
        messageData.replyToId = replyToMessageId;
        replyToMessageId = null;
        replyPreview.classList.add("hidden");
      }

      await addDoc(collection(db, chatPath), messageData);
      messageInput.value = "";
      messagesWrap.scrollTop = messagesWrap.scrollHeight;
    };

    // --- Lógica del modal de invitar ---
    btnInvite.onclick = () => {
      inviteModal.style.display = "flex";
      inviteUserInput.value = "";
    };

    btnCancelInvite.onclick = () => {
      inviteModal.style.display = "none";
    };

    btnSendInvite.onclick = async () => {
      if (!currentChat || currentChat.type !== "group") {
        inviteModal.style.display = "none";
        return alert("Abre un grupo primero.");
      }
      
      const uname = inviteUserInput.value.trim().toLowerCase();
      if (!uname) return alert("Escribe un usuario.");
      
      const q = query(collection(db, `${appPath}/users`), where("name","==", uname));
      const snap = await getDocs(q);
      
      if (snap.empty) return alert("Usuario no encontrado.");
      
      const userDoc = snap.docs[0];
      const userId = userDoc.id;

      const groupRef = doc(db, `${appPath}/groups`, currentChat.id);
      const groupSnap = await getDoc(groupRef);
      if (!groupSnap.exists()) return;
      const data = groupSnap.data();
      const members = data.members || [];
      if (!members.includes(userId)) {
        members.push(userId);
        const names = data.membersNames || [];
        names.push(userDoc.data().name);
        await updateDoc(groupRef, {members: members, membersNames: names});
      }
      inviteModal.style.display = "none";
    };

    // --- Lógica del modal de reaccionar (modificada) ---
    emojiList.onclick = async (e) => {
        if (e.target.tagName === "SPAN") {
            const emoji = e.target.textContent;
            const messageId = reactModal.dataset.messageId;
            if (!messageId || !currentChat) return;

            const chatPath = currentChat.type === "group" ? `${appPath}/groups/${currentChat.id}/messages` : `${appPath}/privateChats/${currentChat.id}/messages`;

            await addDoc(collection(db, chatPath), {
                text: emoji,
                authorId: currentUser.uid,
                authorName: currentUser.displayName || currentUser.email,
                replyToId: messageId,
                createdAt: serverTimestamp()
            });

            reactModal.style.display = "none";
        }
    };
    btnCancelReact.onclick = () => {
        reactModal.style.display = "none";
    };

    // --- Lógica del modal de reenviar ---
    async function showForwardModal() {
        forwardChatList.innerHTML = "";
        forwardModal.style.display = "flex";

        const groupSnap = await getDocs(query(collection(db, `${appPath}/groups`), where("members", "array-contains", currentUser.uid)));
        groupSnap.forEach(docSnap => {
            const data = docSnap.data();
            const div = document.createElement("div");
            div.className = "p-2 rounded cursor-pointer hover:bg-gray-700";
            div.textContent = "📌 " + data.name;
            div.onclick = () => forwardMessageToChat("group", docSnap.id);
            forwardChatList.appendChild(div);
        });

        const privateSnap = await getDocs(query(collection(db, `${appPath}/privateChats`), where("participants", "array-contains", currentUser.uid)));
        for (const docSnap of privateSnap.docs) {
            const data = docSnap.data();
            const otherId = (data.participants || []).find(uid => uid !== currentUser.uid);
            if (!otherId) continue;
            const otherUserDoc = await getDoc(doc(db, `${appPath}/users`, otherId));
            const otherUserName = otherUserDoc.exists() ? otherUserDoc.data().name : 'Usuario Desconocido';
            const div = document.createElement("div");
            div.className = "p-2 rounded cursor-pointer hover:bg-gray-700";
            div.textContent = "💬 " + otherUserName;
            div.onclick = () => forwardMessageToChat("private", docSnap.id);
            forwardChatList.appendChild(div);
        }
    }

    async function forwardMessageToChat(type, id) {
        if (!forwardedMessageText) return;
        const chatPath = type === "group" ? `${appPath}/groups/${id}/messages` : `${appPath}/privateChats/${id}/messages`;
        
        await addDoc(collection(db, chatPath), {
            text: forwardedMessageText,
            authorId: currentUser.uid,
            authorName: currentUser.displayName || currentUser.email,
            originalAuthorName: forwardedAuthorName,
            createdAt: serverTimestamp()
        });

        forwardModal.style.display = "none";
        forwardedMessageText = null;
        forwardedAuthorName = null;
        alert("Mensaje reenviado con éxito.");
    }

    btnCancelForward.onclick = () => {
        forwardModal.style.display = "none";
    };

    // --- Lógica de reenviar, responder y reaccionar (Faltantes) ---
    window.handleReply = (messageId, authorName, messageText) => {
        replyToMessageId = messageId;
        replyAuthor.textContent = authorName;
        replyText.textContent = messageText.trim().replace(/\n/g, ' ');
        replyPreview.classList.remove('hidden');
        messageInput.focus();
        closeAllOptionMenus();
    };

    window.handleReact = (messageId) => {
        reactModal.dataset.messageId = messageId;
        reactModal.style.display = 'flex';
        closeAllOptionMenus();
    };

    window.handleForward = (messageText, authorName) => {
        forwardedMessageText = messageText;
        forwardedAuthorName = authorName;
        showForwardModal();
        closeAllOptionMenus();
    };
    
    // --- Lógica de salida del chat (modificado para diseño móvil) ---
    btnLeave.onclick = () => {
        currentChat = null;
        messagesWrap.innerHTML = "<p class='text-gray-400'>Selecciona un chat.</p>";
        btnInvite.classList.add("hidden");
        // Ocultar chat y mostrar lista
        chatMainContainer.classList.add('hidden');
        chatMainContainer.classList.remove('flex');
        chatListContainer.classList.remove('hidden');
    };
    
    // Nuevo manejador para el botón de volver en móvil
    btnBackToChats.onclick = () => {
      btnLeave.click();
    };

    // Escucha de clic global para cerrar menús de opciones.
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.message-bubble') && !e.target.closest('.chat-item-options-menu') && !e.target.closest('.chat-item-options') ) {
            closeAllOptionMenus();
        }
    });

    onAuthStateChanged(auth, (user) => {
        console.log("Estado de autenticación cambiado.");
      if (!user) { window.location.href = "login.html"; return; }
      currentUser = user;
      console.log("Usuario autenticado. Cargando grupos y chats.");
      loadGroups();
      loadPrivates();
    });
  </script>
</body>
</html>
